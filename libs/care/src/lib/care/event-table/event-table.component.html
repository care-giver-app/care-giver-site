<div class="recent-activity-card">
    <div class="recent-activity-header">
        <h2 class="recent-activity-title">Recent Activity</h2>
        <button mat-button color="primary" class="add-event-btn" type="button" (click)="onLogEvent()">Add Event</button>
    </div>
    <table mat-table class="event-table" [dataSource]="rows">

        <!-- Event Column -->
        <ng-container matColumnDef="event">
            <th mat-header-cell *matHeaderCellDef>Event</th>
            <td mat-cell *matCellDef="let row">
                <img class="event-icon" [src]="row.meta.icon" title="{{ row.meta.type }}" alt="{{ row.meta.type }}">
                @if (!isMobile){
                <span class="event-name">{{ row.meta.type }}</span>
                }
            </td>
        </ng-container>

        <!-- Last Logged Column -->
        <ng-container matColumnDef="lastLogged">
            <th mat-header-cell *matHeaderCellDef>Logged</th>
            <td mat-cell *matCellDef="let row">
                {{ row.readableTimestamp || 'N/A' }}
            </td>
        </ng-container>

        <!-- Logged By Column -->
        <ng-container matColumnDef="loggedBy">
            <th mat-header-cell *matHeaderCellDef>Logged By</th>
            <td mat-cell *matCellDef="let row">
                {{ row.loggedUser || 'N/A' }}
            </td>
        </ng-container>

        <!-- Data Point Column -->
        <ng-container matColumnDef="dataPoint">
            <th mat-header-cell *matHeaderCellDef>Data</th>
            <td mat-cell *matCellDef="let row">
                <span>
                    {{ row.data ? (row.data.value + ' ' + (row.meta.data ? row.meta.data.unit : '')) : '' }}
                </span>
            </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef style="border: none;"></th>
            <td mat-cell *matCellDef="let row" style="border: none;">
                <button mat-icon-button class="log-now-btn" title="Log Now" (click)="onQuickLogEvent(row.meta.type)">
                    <mat-icon>add</mat-icon>
                </button>
                <button mat-icon-button class="delete-btn" title="Delete Latest Event"
                    (click)="onDeleteEvent(row.eventId || '')">
                    <mat-icon>delete</mat-icon>
                </button>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
</div>

<care-modal [show]="showModal" [header]="'Add Event'" (close)="closeModal()">
    <div modal-body>
        <label for="eventTypeSelect">Type</label>
        <select id="eventTypeSelect" [(ngModel)]="selectedEventType" (ngModelChange)="getMetadata($event)"
            class="form-control">
            @for (type of eventTypes; track type) {
            <option [value]="type.type">{{ type.type }}</option>
            }
        </select>
        <div class="modal-row">
            <label for="timestampInput">Timestamp</label>
            <input id="timestampInput" type="datetime-local" class="form-control" [(ngModel)]="timestampValue" />
        </div>
        @if (selectedEventMetadata && selectedEventMetadata.data) {
        <label for="dataInput">{{ selectedEventMetadata.data.name }}</label>
        <input id="dataInput" [(ngModel)]="inputData" type="number"
            placeholder="Enter {{ selectedEventMetadata.data.name }}" class="form-control" />
        }
    </div>
    <div modal-footer>
        <button class="btn btn-primary modal-button" (click)="submitEvent()">Add Event</button>
        <button class="btn btn-secondary modal-button" (click)="closeModal()">Cancel</button>
    </div>
</care-modal>